<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" type="image/png" href="/assets/images/musios-logo-black-circle.png"><!-- Begin Jekyll SEO tag v2.8.0 -->
  <title>Web Sheet Music Viewer | musios.app</title>

  <meta property="og:title" content="Web Sheet Music Viewer | musios.app" />
  <meta property="og:locale" content="en" />
  <meta name="description" content="A collection of tools for music creators and performers" />
  <meta property="og:description" content="A collection of tools for music creators and performers" />
  <meta property="og:url" content="https://localhost:4000/" />
  <meta property="og:site_name" content="musios.app" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary" />
  <meta property="twitter:title" content="musios.app Home" />
  <meta name="author" content="Andrew Hunt (musios)" />

  <script type="application/ld+json">
    {"@context":"https://schema.org","@type":"WebSite","author":{"@type":"Person","name":"Andrew Hunt (musios)"},"description":"A collection of tools for music creators and performers","headline":"musios.app Home","name":"musios.app","url":"https://localhost:4000/"}
  </script>

  <!-- Material Design for Bootstrap -->
  <link href="assets/mdb/mdb.min.css" rel="stylesheet"/>

  <link rel="stylesheet" href="assets/bootstrap-table/bootstrap-table.min.css">
  <link rel="stylesheet" href="assets/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.css">

  <link href="assets/css/sheetviewer.css" rel="stylesheet"/>

  <!-- Google tag (gtag.js) -->
  <!--
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TE1EYGTYEW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-TE1EYGTYEW');
  </script>
  -->

</head>

<body>

<div class="container-fluid">
  <div class="container-fluid bg-warning text-light text-center p-3">
    STATUS: in development and not yet functional
  </div>

  <header>

    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">
          <img src="assets/images/musios-logo-blue-circle.svg" alt="musios.app logo">
        </a>

        <div class="collapse navbar-collapse">
          <div class="navbar-nav me-auto text-primary">
            Sheet Music Viewer - musios.app
          </div>

          <div class="navbar-nav me-auto">
            <a data-mdb-dropdown-init class="btn btn-outline-secondary dropdown-toggle" href="#" id="file-selection" role="button" aria-expanded="false">
              Select Song
            </a>
            <ul id="file-selection-list" class="dropdown-menu" aria-labelledby="file-selection">
              <li>
                <a class="dropdown-item">No sheet music files found</a> 
              </li>
            </ul>
          </div>

          <div class="navbar-nav view-selection">
            <div class="btn-group">
              <input type="radio" class="btn-check" name="viewOptions" id="managerMode" autocomplete="off" autocompleted="" onchange="viewChange(event.target.id)" checked>
              <label class="btn btn-outline-secondary" for="managerMode" data-mdb-ripple-init="">Manager</label>

              <input type="radio" class="btn-check" name="viewOptions" id="viewerMode" autocomplete="off" autocompleted="" onchange="viewChange(event.target.id)">
              <label class="btn btn-outline-secondary" for="viewerMode" data-mdb-ripple-init="">Viewer</label>
            </div>
          </div>

        </div>

      </div>
    </nav>
  </header>


  <section class="error">
    <div id="error-message" style="display: none">&nbsp; some kind of error</div>
  </section>

  <section id="display-selector">

    <div class="display-manager sheet-manager">
      <div class="row">
        <div class="col-2">
          <div class="add-sheet-music">
            <h5 class="card-title text-center pt-2 pb-3">Add Sheet Music</h5>

            <div class="dropzone w-100 align-items-center text-center my-2">
              Drop files here
              <img class="my-2" src="assets/images/music-file-icon.png" height="100"/>
            </div>
            
            <p class="text-center my-2">OR</p>

            <div class="my-2" style="text-align: center;">
              <label for="fileInput" class="btn btn-outline-secondary">Choose file(s)</label>
              <input type="file" id="fileInput" name="fileInput" style="display: none;" multiple />
            </div>

            <p class="text-center my-2" style="color: #888">OR</p>

            <p class="text-center my-2" style="color: #888">(Past URL)</p>

          </div>


          <!-- <div>
            Supported file types:
            <ul>
              <li>PDF</li>
            </ul>
          </div> -->
        </div>


        <div class="col-10">
          <div id="manage-area">
            <h5 class="card-title text-center">Manage Sheet Music</h5>

            <table
              width="50%"
              id="sheet-music-table"
              data-pagination="false"
              data-search="false"
              data-show-toggle="true"
              data-custom-sort="customSort"
              data-toolbar="false"
              data-use-row-attr-func="true"
              data-reorderable-rows="true"
            >
            
              <thead>
                <tr>
                  <th data-field="drag" data-checkbox="false">Order</th>
                  <!-- <th data-field="state" data-checkbox="true">Toggle</th> -->
                  <th data-field="view" data-checkbox="false">View</th>
                  <th data-field="songname" data-sortable="true">Song name</th>
                  <th data-field="filename" data-sortable="true">Filename</th>
                  <th data-field="type" data-sortable="true">Type</th>
                  <th data-field="size" data-sortable="true">Size</th>
                </tr>
              </thead>
              <tbody>
            
              </tbody>
            </table>
          
          </div>
        </div>

      </div>

    </div>


    <div class="display-viewer sheet-wrapper">
      <iframe id="pdf-iframe"></iframe>
  </div>
  </section>





  <!-- JQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Material Design for Bootstrap -->
  <script type="text/javascript" src="assets/mdb/mdb.umd.min.js"></script>

  <script src="assets/TableDnD/jquery.tablednd.1.0.5.min.js"></script>
  <script src="assets/bootstrap-table/bootstrap-table.min.js"></script>
  <script src="assets/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.min.js"></script>

  <!-- Custom scripts -->
  <script src="assets/js/droparea.js"></script>
  <script src="assets/js/midi-sheet-request.js"></script>
  <script src="assets/js/musios-sheet-storage.js"></script>
  
  <script>
    <!-- scripts for management of the display -->

    function viewChange(id) {
      $("body .display-viewer").hide()
      $("body .display-manager").hide()

      if (id === "viewerMode") 
        $(`body .display-viewer`).show()
      else if (id === "managerMode") 
        $(`body .display-manager`).show()
    }

    function updateMenu() {
      const fileSelectionMenu = $("#file-selection")
      const fileSelectionList = $('#file-selection-list')

      sheetData.getSheetNames(filenames => {
        console.log(filenames)
        if (!filenames || filenames.length === 0) {
          fileSelectionMenu.addClass("disabled")
          return
        }x

        fileSelectionList.empty()
        fileSelectionMenu.removeClass("disabled")

        const liItem = $(`<li><a class='dropdown-item' href='#'>${filename}</a></li>`)
        fileSelectionList.append(liItem)

        liItem.click(event => {
          console.log(filename)
        })
      })
    }

    
    setDropArea(document.getElementById('droparea'), (filename, filetype, dataURI) => {
      sheetData.addSheet(filename, filetype, dataURI, () => {
        updateMenu();
        showSheet(dataURI);
      }, (error) => {
        console.error(error);
      });
    })
  </script>

  <script>
    function showSheet(filename) {
      // Display parameters: https://pdfobject.com/pdf/pdf_open_parameters_acro8.pdf
      //
      // view=FitH | FitV, FitR, FitB, FitBH, FitBV
      // zoom=nn%
      // 
      // navpanes=1 | 0
      // toolbar=1 | 0
      // toolbar: 0, 1, 2 top|bottom|both|none
      //
      // scrollbar=1|0

      const pdfDisplayOpts = "#view=FitB&toolbar=1";

      if (filename.startsWith('data:')) {
        document.getElementById("pdf-iframe").setAttribute('src', filename + pdfDisplayOpts);
      }
      else {
        const dataURI = sheetData.getSheet(filename,
          sheet => document.getElementById("pdf-iframe").setAttribute('src', sheet.data + pdfDisplayOpts),
          error => console.error(error)
        );
      }
    }

    const aboutHTML = `
      <html>
        <head>
          <style>
            body {
              font-family: Arial, sans-serif;
              padding: 20px;
            }
          </style>
        </head>
        <body>
          <h1>Sheet Viewer by musios.app</h1>
          <p>This is a simple web-based sheet music viewer that can be controlled via MIDI messages.</p>
        </body>
      </html>
    `

    const aboutHTML_dataURI = `data:text/html;base64,${btoa(unescape(encodeURIComponent(aboutHTML)))}`

    showSheet(aboutHTML_dataURI)
  </script>

  <script>
    /*
    function selectSong(songName) {
      const elSelect = document.getElementById('file-selection');
      let found = false;

      for (const option of elSelect.options) {
        const filename = option.value.substring(option.value.lastIndexOf('/') + 1);

        if (filename.trim().toLowerCase().startsWith(songName.trim().toLowerCase())) {
          // console.log(`Found song: ${songName}`);
          elSelect.value = option.value;
          showSheet(option.value);
          found = true;
          document.getElementById("error-message").innerHTML = "&nbsp;";
          break;
        }
      }

      if (!found) {
        document.getElementById("error-message").innerText = "Song not found: " + songName;
      }
    }
    */
  </script>

  <script>
    /*
    const pdfMidiDevice = "IAC Driver PDFBrowser"

    initMidiSheetRequest(
      pdfMidiDevice,
      songName => selectSong(songName)
    )
    */
  </script>


  <script>
    const supportedMediaTypes = {
      "application/pdf": {
        type: "PDF",
        icon: "assets/images/fa-pdf.svg",
      }
    };

    $(function() {
      const tbody = $("#sheet-music-table tbody");

      sheetData.getSheetNames(filenames => {
        // console.log("filenames", filenames);

        filenames.forEach(filename => {
          sheetData.getSheet(filename, data => {
            $('#sheet-music-table').bootstrapTable('insertRow', {
              index: 1,
              row: {
                order: `<img src="assets/images/fa-bars.svg" height="20px"/>`,
                view: `<img src="assets/images/fa-eye-regular.svg" height="20px"/>`,
                filename: filename,
                songname: filename,
                type: `<!-- ${supportedMediaTypes[data.filetype].type} --> <img src="${supportedMediaTypes[data.filetype].icon}" height="20px"/>`,
                size: data.data.length,
              }
            });
          }, error => console.error(error));
        });
      });

      $('#sheet-music-table').bootstrapTable({
        dragHandle: '.reorder',
        columns: [
          {
            title: 'Order',
            field: 'order',
            class: 'reorder'
          },
          {
            title: 'View',
            field: 'view',
            class: 'view',
            align: 'center'
          },
          {
            title: 'Song name',
            field: 'songname',
            class: 'songname'
          },
          {
            title: 'Filename',
            field: 'filename',
            class: 'filename'
          },
          {
            title: 'Type',
            field: 'type',
            class: 'type',
            align: 'center',
          },
          {
            title: 'Size',
            field: 'size',
            class: 'size',
            align: 'right',
            formatter: function (value) {
              if (value < 1024) return value + ' bytes';
              value = value / 1024;
              if (value < 1024) return Math.round(value) + 'KB';
              value = value / 1024;
              if (value < 1024) return Math.round(value) + 'MB';
              value = value / 1024;
              if (value < 1024) return Math.round(value) + 'GB';
            }
          },
        ]
      });
    });

    function customSort(sortName, sortOrder, data) {
      console.log(sortName, sortOrder, data);

      var order = sortOrder === 'desc' ? -1 : 1
      data.sort(function (a, b) {
        var aa = +((a[sortName] + '').replace(/[^\d]/g, ''))
        var bb = +((b[sortName] + '').replace(/[^\d]/g, ''))

        if (aa < bb) {
          return order * -1
        }
        if (aa > bb) {
          return order
        }
        return 0
      })
    }  
  </script>




  <script>
    function initDisplay() {
      console.log('Initializing viewer');

      sheetData.init(() => {
        console.log('Sheet data initialized');
        viewChange("managerMode")
        // updateMenu()
      }, (error) => {
        console.error(error);
      });
    }


    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initDisplay)
    } else {
      initDisplay()  
    }
  </script>

</body>

</html>